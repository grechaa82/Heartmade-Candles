CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);

START TRANSACTION;

CREATE TABLE "Token" (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    "userId" integer NOT NULL,
    "accessToken" text NOT NULL,
    "refreshToken" text NOT NULL,
    "expireTime" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Token" PRIMARY KEY (id)
);

CREATE TABLE "User" (
    id integer GENERATED BY DEFAULT AS IDENTITY,
    email text NOT NULL,
    "userName" text NOT NULL,
    "passwordHash" text NOT NULL,
    "registrationDate" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_User" PRIMARY KEY (id)
);

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20240315151517_InitUserAndAuthDb', '7.0.5');

COMMIT;

START TRANSACTION;

ALTER TABLE "User" ADD role integer NOT NULL DEFAULT 0;

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20240326112610_AddedRoleForUser', '7.0.5');

COMMIT;

START TRANSACTION;

DROP TABLE "Token";

CREATE TABLE "Session" (
    id uuid NOT NULL,
    "userId" integer NOT NULL,
    "refreshToken" text NOT NULL,
    "expireAt" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Session" PRIMARY KEY (id),
    CONSTRAINT "FK_Session_User_userId" FOREIGN KEY ("userId") REFERENCES "User" (id) ON DELETE CASCADE
);

CREATE INDEX "IX_Session_userId" ON "Session" ("userId");

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20240329152929_ReplacedTokenWithSession', '7.0.5');

COMMIT;

